<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ’£ MINEFIELD 2P</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap');

:root {
  --bg: #0e0e14;
  --surf: #16161f;
  --border: #252535;
  --p1: #f5c542;
  --p2: #42c8f5;
  --p1d: rgba(245,197,66,0.15);
  --p2d: rgba(66,200,245,0.15);
  --danger: #ff3d5a;
  --safe: #3dff9a;
  --text: #dde1f0;
  --muted: #555570;
  --cell: #1c1c28;
  --cell-h: #242436;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Mono', monospace;
  min-height: 100svh;
  display: flex;
  flex-direction: column;
  align-items: center;
  overflow-x: hidden;
  background-image:
    radial-gradient(ellipse 60% 40% at 10% 0%, rgba(245,197,66,.04) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 90% 100%, rgba(66,200,245,.04) 0%, transparent 60%);
}

/* â”€â”€ TYPOGRAPHY â”€â”€ */
.bebas { font-family: 'Bebas Neue', sans-serif; letter-spacing: .06em; }

/* â”€â”€ SCREENS â”€â”€ */
.screen { display: none; flex-direction: column; align-items: center; width: 100%; max-width: 520px; padding: 20px 16px; gap: 14px; }
.screen.active { display: flex; }

/* â”€â”€ LOGO â”€â”€ */
.logo {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(2.4rem, 8vw, 3.4rem);
  letter-spacing: .12em;
  background: linear-gradient(135deg, var(--p1) 0%, var(--p2) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  line-height: 1;
  margin-bottom: 2px;
}
.logo-sub {
  font-size: .6rem;
  letter-spacing: .35em;
  color: var(--muted);
  margin-bottom: 6px;
  text-align: center;
}

/* â”€â”€ CARD â”€â”€ */
.card {
  background: var(--surf);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  width: 100%;
}
.card-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1rem;
  letter-spacing: .15em;
  margin-bottom: 14px;
  color: var(--muted);
}

/* â”€â”€ INPUTS â”€â”€ */
label { font-size: .62rem; letter-spacing: .12em; color: var(--muted); display: block; margin-bottom: 5px; }
input[type=text] {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: 'DM Mono', monospace;
  font-size: .85rem;
  padding: 11px 14px;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
  margin-bottom: 12px;
}
input[type=text]:focus { border-color: var(--p1); box-shadow: 0 0 0 3px rgba(245,197,66,.12); }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1rem;
  letter-spacing: .15em;
  padding: 13px 18px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  width: 100%;
  transition: all .18s;
}
.btn-p1 { background: var(--p1); color: #0e0e14; }
.btn-p1:hover { filter: brightness(1.12); box-shadow: 0 0 20px rgba(245,197,66,.35); }
.btn-p2 { background: var(--p2); color: #0e0e14; }
.btn-p2:hover { filter: brightness(1.12); box-shadow: 0 0 20px rgba(66,200,245,.35); }
.btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--muted); font-family: 'DM Mono', monospace; font-size: .7rem; letter-spacing: .1em; }
.btn-ghost:hover { border-color: var(--danger); color: var(--danger); }
.btn:disabled { opacity: .4; cursor: not-allowed; }

.or-divider {
  display: flex; align-items: center; gap: 10px;
  color: var(--muted); font-size: .6rem; letter-spacing: .2em;
  width: 100%;
}
.or-divider::before,.or-divider::after { content:''; flex:1; height:1px; background:var(--border); }

/* â”€â”€ DIFFICULTY â”€â”€ */
.diff-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 14px; }
.diff-opt {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 6px;
  text-align: center;
  cursor: pointer;
  transition: all .18s;
}
.diff-opt .dn { font-family:'Bebas Neue',sans-serif; font-size:.9rem; letter-spacing:.1em; display:block; }
.diff-opt .ds { font-size:.52rem; color:var(--muted); display:block; margin-top:2px; }
.diff-opt.sel { border-color: var(--p1); background: var(--p1d); }
.diff-opt.sel .dn { color: var(--p1); }

/* â”€â”€ WAITING â”€â”€ */
.room-code {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 3.5rem;
  letter-spacing: .5em;
  color: var(--p1);
  text-shadow: 0 0 30px rgba(245,197,66,.5);
  text-align: center;
  margin: 10px 0;
}
.copy-link {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 12px;
  font-size: .6rem;
  color: var(--muted);
  word-break: break-all;
  cursor: pointer;
  transition: border-color .2s;
  width: 100%;
  text-align: left;
  margin-bottom: 10px;
}
.copy-link:hover { border-color: var(--p1); }
.copy-link-label { color: var(--p1); font-size: .55rem; letter-spacing: .1em; display: block; margin-bottom: 4px; }

.dots { display:flex; gap:7px; justify-content:center; margin:12px 0; }
.dots span {
  width:9px; height:9px; border-radius:50%; background:var(--p1);
  animation: db 1.2s ease-in-out infinite;
}
.dots span:nth-child(2){animation-delay:.2s;}
.dots span:nth-child(3){animation-delay:.4s;}
@keyframes db { 0%,100%{transform:translateY(0);opacity:.25;} 50%{transform:translateY(-7px);opacity:1;} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#game {
  max-width: 100%;
  padding: 10px 8px;
  gap: 8px;
}

/* scoreboard */
.scoreboard {
  display: flex;
  align-items: stretch;
  gap: 6px;
  width: 100%;
}

.player-score {
  flex: 1;
  background: var(--surf);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  display: flex;
  flex-direction: column;
  gap: 2px;
  min-width: 0;
}
.player-score.p1s { border-color: rgba(245,197,66,.3); }
.player-score.p2s { border-color: rgba(66,200,245,.3); }
.player-score.leading-p1 { box-shadow: 0 0 16px rgba(245,197,66,.2); }
.player-score.leading-p2 { box-shadow: 0 0 16px rgba(66,200,245,.2); }

.ps-name {
  font-size: .6rem;
  letter-spacing: .12em;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.ps-name span { font-size: .5rem; margin-left: 3px; }
.ps-pts {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2rem;
  line-height: 1;
  letter-spacing: .05em;
}
.p1s .ps-pts { color: var(--p1); }
.p2s .ps-pts { color: var(--p2); }
.ps-detail { font-size: .55rem; color: var(--muted); }

.center-hud {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  min-width: 60px;
}
.hud-mines {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.5rem;
  color: var(--danger);
  line-height: 1;
}
.hud-mines-label { font-size: .48rem; color: var(--muted); letter-spacing: .12em; }
.hud-timer {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.1rem;
  color: var(--text);
  letter-spacing: .1em;
}

/* status bar */
.status-bar {
  width: 100%;
  background: var(--surf);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 14px;
  font-size: .65rem;
  letter-spacing: .1em;
  color: var(--muted);
  text-align: center;
  transition: all .3s;
}
.status-bar.go { border-color: var(--safe); color: var(--safe); }
.status-bar.boom { border-color: var(--danger); color: var(--danger); }

/* progress bar */
.progress-wrap {
  width: 100%;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--p1), var(--safe));
  border-radius: 2px;
  transition: width .4s ease;
}

/* board */
.board-outer {
  width: 100%;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: #0a0a10;
}

#board {
  display: grid;
  gap: 1.5px;
  padding: 6px;
  touch-action: none;
}

.cell {
  width: 36px;
  height: 36px;
  border-radius: 5px;
  background: var(--cell);
  border: 1px solid #222230;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'Bebas Neue', sans-serif;
  font-size: .9rem;
  cursor: pointer;
  transition: background .12s, transform .08s, box-shadow .12s;
  position: relative;
  -webkit-user-select: none;
  user-select: none;
}
.cell:active { transform: scale(.9); }

/* states */
.cell.rev-p1 { background: #1a1a10; border-color: rgba(245,197,66,.12); }
.cell.rev-p2 { background: #0f1a1a; border-color: rgba(66,200,245,.12); }
.cell.flag-p1 { background: var(--p1d); border-color: var(--p1); }
.cell.flag-p2 { background: var(--p2d); border-color: var(--p2); }
.cell.boom-cell { background: rgba(255,61,90,.25); border-color: var(--danger); animation: boom .35s ease-out; }
@keyframes boom { 0%{transform:scale(1.5);} 100%{transform:scale(1);} }

/* long-press ring */
.cell::after {
  content: '';
  position: absolute;
  inset: -2px;
  border-radius: 7px;
  border: 2px solid transparent;
  transition: border-color .1s;
}
.cell.pressing::after { border-color: var(--p1); animation: pressRing .3s linear forwards; }
@keyframes pressRing {
  0%   { clip-path: inset(0 100% 0 0); }
  100% { clip-path: inset(0 0 0 0); }
}

/* numbers */
.n1{color:#5bc4f0} .n2{color:#6dd97a} .n3{color:#f5a742}
.n4{color:#9b72f5} .n5{color:#f55a5a} .n6{color:#42f5d8}
.n7{color:#f5427a} .n8{color:#aaaacc}

/* bottom toolbar */
.toolbar {
  display: flex;
  gap: 8px;
  width: 100%;
  padding: 4px 0;
}
.tool-btn {
  flex: 1;
  background: var(--surf);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--muted);
  font-family: 'DM Mono', monospace;
  font-size: .62rem;
  padding: 9px 6px;
  cursor: pointer;
  transition: all .18s;
  text-align: center;
  letter-spacing: .06em;
}
.tool-btn:hover { border-color: var(--p1); color: var(--text); }
.tool-btn.danger:hover { border-color: var(--danger); color: var(--danger); }

/* hint tip */
.hint-tip {
  font-size: .58rem;
  color: var(--muted);
  letter-spacing: .1em;
  text-align: center;
}

/* live dot */
.live-dot {
  display: inline-block;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--safe);
  box-shadow: 0 0 6px var(--safe);
  animation: livePulse 1.5s ease-in-out infinite;
  vertical-align: middle;
  margin-right: 5px;
}
@keyframes livePulse { 0%,100%{opacity:1;} 50%{opacity:.3;} }

/* overlay */
#overlay {
  display: none;
  position: fixed; inset: 0;
  background: rgba(14,14,20,.93);
  backdrop-filter: blur(8px);
  z-index: 200;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  gap: 14px;
  text-align: center;
  padding: 24px;
}
#overlay.show { display: flex; }
.ov-emoji { font-size: 4rem; }
.ov-title {
  font-family: 'Bebas Neue', sans-serif;
  font-size: clamp(2rem,8vw,3.5rem);
  letter-spacing: .1em;
}
.ov-subtitle { font-size: .75rem; color: var(--muted); letter-spacing: .1em; margin-top:-6px; }
.ov-scores {
  display: flex; gap: 16px; margin-top: 6px;
}
.ov-score {
  background: var(--surf);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 14px 20px;
  min-width: 110px;
}
.ov-score-name { font-size: .6rem; color: var(--muted); letter-spacing: .1em; }
.ov-score-pts { font-family:'Bebas Neue',sans-serif; font-size: 2.5rem; line-height: 1; }
.ov-score-detail { font-size: .55rem; color: var(--muted); margin-top: 2px; }
.ov-score.winner { border-color: var(--p1); }
.ov-score.winner .ov-score-pts { color: var(--p1); }
.ov-score.loser .ov-score-pts { color: var(--p2); }
.ov-btns { display: flex; gap: 10px; margin-top: 6px; flex-wrap: wrap; justify-content: center; }
.ov-btn {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1rem;
  letter-spacing: .15em;
  padding: 13px 28px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all .18s;
}

/* toast */
#toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surf);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 18px;
  font-size: .65rem;
  color: var(--text);
  opacity: 0;
  transition: all .3s;
  pointer-events: none;
  z-index: 300;
  white-space: nowrap;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- LOBBY -->
<div class="screen active" id="screen-lobby">
  <div class="logo">MINEFIELD</div>
  <div class="logo-sub">2-PLAYER Â· REALTIME Â· SIMULTANEOUS</div>

  <div class="card">
    <div class="card-title">âš¡ Create Room</div>
    <label>YOUR NAME</label>
    <input type="text" id="createName" placeholder="Enter name..." maxlength="14">
    <label>DIFFICULTY</label>
    <div class="diff-grid">
      <div class="diff-opt sel" data-d="easy" onclick="pickDiff(this)">
        <span class="dn">EASY</span>
        <span class="ds">9Ã—9 Â· 10ğŸ’£</span>
      </div>
      <div class="diff-opt" data-d="medium" onclick="pickDiff(this)">
        <span class="dn">MEDIUM</span>
        <span class="ds">16Ã—16 Â· 40ğŸ’£</span>
      </div>
      <div class="diff-opt" data-d="hard" onclick="pickDiff(this)">
        <span class="dn">HARD</span>
        <span class="ds">20Ã—16 Â· 60ğŸ’£</span>
      </div>
    </div>
    <button class="btn btn-p1" onclick="createRoom()">CREATE ROOM</button>
  </div>

  <div class="or-divider">OR</div>

  <div class="card">
    <div class="card-title">ğŸ”— Join Room</div>
    <label>YOUR NAME</label>
    <input type="text" id="joinName" placeholder="Enter name..." maxlength="14">
    <label>ROOM CODE</label>
    <input type="text" id="joinCode" placeholder="XXXXXX"
      style="letter-spacing:.4em;font-size:1.3rem;text-align:center;text-transform:uppercase;" maxlength="6">
    <button class="btn btn-p2" onclick="joinRoom()">JOIN ROOM</button>
  </div>
</div>

<!-- WAITING -->
<div class="screen" id="screen-wait">
  <div class="logo" style="font-size:2rem;">MINEFIELD</div>
  <div class="card" style="text-align:center;">
    <div class="card-title" style="text-align:center;">WAITING FOR PLAYER 2</div>
    <div class="room-code" id="displayCode">------</div>
    <div class="copy-link" id="copyLinkBox" onclick="copyLink()">
      <span class="copy-link-label">ğŸ”— SHAREABLE LINK â€” TAP TO COPY</span>
      <span id="linkText"></span>
    </div>
    <div class="dots"><span></span><span></span><span></span></div>
    <p style="font-size:.62rem;color:var(--muted);margin-bottom:14px;">Share the code or link with your friend</p>
    <button class="btn btn-ghost" onclick="leaveRoom()">CANCEL</button>
  </div>
</div>

<!-- GAME -->
<div class="screen" id="game">
  <!-- Scoreboard -->
  <div class="scoreboard">
    <div class="player-score p1s" id="p1score">
      <div class="ps-name" id="p1label">P1 <span>ğŸŸ¡</span></div>
      <div class="ps-pts" id="p1pts">0</div>
      <div class="ps-detail" id="p1detail">0 cells Â· 0 flags</div>
    </div>

    <div class="center-hud">
      <div class="hud-mines" id="minesLeft">--</div>
      <div class="hud-mines-label">MINES</div>
      <div class="hud-timer" id="timerEl">00:00</div>
    </div>

    <div class="player-score p2s" id="p2score">
      <div class="ps-name" id="p2label">P2 <span>ğŸ”µ</span></div>
      <div class="ps-pts" id="p2pts">0</div>
      <div class="ps-detail" id="p2detail">0 cells Â· 0 flags</div>
    </div>
  </div>

  <!-- Progress -->
  <div class="progress-wrap"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>

  <!-- Status -->
  <div class="status-bar" id="statusBar">
    <span class="live-dot"></span>BOTH PLAYERS CONNECTED â€” GAME IN PROGRESS
  </div>

  <!-- Board -->
  <div class="board-outer">
    <div id="board"></div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="tool-btn" onclick="copyLink()" style="flex:.8;">ğŸ”— LINK</div>
    <div class="tool-btn danger" onclick="leaveRoom()">âœ• LEAVE</div>
  </div>
  <div class="hint-tip">TAP = reveal &nbsp;Â·&nbsp; LONG PRESS = flag/unflag</div>
</div>

<!-- OVERLAY -->
<div id="overlay">
  <div class="ov-emoji" id="ovEmoji">ğŸ‰</div>
  <div class="ov-title" id="ovTitle">GAME OVER</div>
  <div class="ov-subtitle" id="ovSub"></div>
  <div class="ov-scores" id="ovScores"></div>
  <div class="ov-btns">
    <button class="ov-btn btn-p1" onclick="restartGame()">PLAY AGAIN</button>
    <button class="ov-btn" style="background:var(--surf);border:1px solid var(--border);color:var(--muted);" onclick="leaveRoom()">LEAVE</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get, update, remove }
  from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

/* â”€â”€â”€ Firebase config â”€â”€â”€ */
const app = initializeApp({
  apiKey: "AIzaSyBJXWSH5FrjbOm9-BtE6_tIR2mnp6FMU4w",
  authDomain: "icms-bc0ff.firebaseapp.com",
  databaseURL: "https://icms-bc0ff-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "icms-bc0ff",
  storageBucket: "icms-bc0ff.firebasestorage.app",
  messagingSenderId: "581524981179",
  appId: "1:581524981179:web:06f2d178a513ffe101f09e"
});
const db = getDatabase(app);

/* â”€â”€â”€ Scoring â”€â”€â”€ */
const PTS_MINE    = 100;  // correctly flagged mine
const PTS_FLAG    = 5;    // correct flag
const PTS_HIT     = -50;  // hit a mine
const LONG_MS     = 300;  // long press duration

/* â”€â”€â”€ Difficulty â”€â”€â”€ */
const DIFF = {
  easy:   { cols:9,  rows:9,  mines:10 },
  medium: { cols:16, rows:16, mines:40 },
  hard:   { cols:20, rows:16, mines:60 }
};

/* â”€â”€â”€ State â”€â”€â”€ */
let roomCode  = '';
let myPlayer  = 0;   // 1 or 2
let myName    = '';
let gs        = null;
let unsub     = null;
let timerItv  = null;
let selDiff   = 'easy';

// long press
let pressTimer  = null;
let pressIdx    = -1;
let isPressing  = false;

/* â”€â”€â”€ Expose globals â”€â”€â”€ */
window.pickDiff    = pickDiff;
window.createRoom  = createRoom;
window.joinRoom    = joinRoom;
window.leaveRoom   = leaveRoom;
window.copyLink    = copyLink;
window.restartGame = restartGame;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pickDiff(el) {
  document.querySelectorAll('.diff-opt').forEach(b => b.classList.remove('sel'));
  el.classList.add('sel');
  selDiff = el.dataset.d;
}

async function createRoom() {
  const name = document.getElementById('createName').value.trim();
  if (!name) return toast('Enter your name!');
  myName = name; myPlayer = 1;
  roomCode = Math.random().toString(36).substring(2,8).toUpperCase();
  const d = DIFF[selDiff];
  const state = {
    diff: selDiff, rows: d.rows, cols: d.cols, mines: d.mines,
    p1Name: name, p2Name: '',
    status: 'waiting',
    board: null,
    cells: Array(d.rows * d.cols).fill(0),
    // 0=hidden, 1=rev-p1, 2=rev-p2, -1=flag-p1, -2=flag-p2, 99=boom
    p1Score:0, p2Score:0,
    p1Cells:0, p2Cells:0,
    p1Flags:0, p2Flags:0,
    p1Hits:0,  p2Hits:0,
    startTime: null,
    version: 0
  };
  await set(ref(db,`mf/${roomCode}`), state);
  gs = state;
  showScreen('screen-wait');
  document.getElementById('displayCode').textContent = roomCode;
  setLink();
  listen();
}

async function joinRoom() {
  const name = document.getElementById('joinName').value.trim();
  const code = (document.getElementById('joinCode').value.trim()).toUpperCase();
  if (!name) return toast('Enter your name!');
  if (!code) return toast('Enter the room code!');
  const snap = await get(ref(db,`mf/${code}`));
  if (!snap.exists()) return toast('Room not found!');
  const s = snap.val();
  if (s.status !== 'waiting') return toast('Game already started!');
  if (s.p2Name) return toast('Room is full!');
  myName = name; myPlayer = 2; roomCode = code; gs = s;
  gs.p2Name = name;
  gs.status = 'playing';
  gs.startTime = Date.now();
  gs.version = 1;
  await set(ref(db,`mf/${roomCode}`), gs);
  listen();
  startGame();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIREBASE LISTENER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function listen() {
  if (unsub) unsub();
  unsub = onValue(ref(db,`mf/${roomCode}`), snap => {
    if (!snap.exists()) return;
    const remote = snap.val();
    if (!gs || remote.version <= gs.version) return;
    gs = remote;

    // P1 waiting â†’ game starts
    if (myPlayer===1 && gs.status==='playing' && gs.p2Name &&
        document.getElementById('screen-wait').classList.contains('active')) {
      startGame();
      return;
    }
    if (gs.status==='playing') {
      renderBoard();
      updateHUD();
    } else if (gs.status==='won'||gs.status==='lost') {
      renderBoard(); updateHUD();
      setTimeout(()=>showOverlay(gs.status),500);
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME START
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startGame() {
  showScreen('game');
  document.getElementById('p1label').innerHTML = `${gs.p1Name} <span>ğŸŸ¡</span>`;
  document.getElementById('p2label').innerHTML = `${gs.p2Name} <span>ğŸ”µ</span>`;
  buildBoardDOM();
  renderBoard();
  updateHUD();
  startTimer();
  toast(`${gs.p1Name} & ${gs.p2Name} â€” GO!`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOARD GENERATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function genBoard(rows, cols, mines, safeIdx) {
  const total = rows*cols;
  const safe = new Set();
  const r0=Math.floor(safeIdx/cols), c0=safeIdx%cols;
  for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
    const nr=r0+dr,nc=c0+dc;
    if(nr>=0&&nr<rows&&nc>=0&&nc<cols) safe.add(nr*cols+nc);
  }
  const pool=[];
  for(let i=0;i<total;i++) if(!safe.has(i)) pool.push(i);
  for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
  const mineSet=new Set(pool.slice(0,mines));
  return Array(total).fill(0).map((_,i)=>{
    if(mineSet.has(i)) return -1;
    let c=0;
    const r=Math.floor(i/cols),col=i%cols;
    for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
      const nr=r+dr,nc=col+dc;
      if(nr>=0&&nr<rows&&nc>=0&&nc<cols&&mineSet.has(nr*cols+nc)) c++;
    }
    return c;
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOARD DOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildBoardDOM() {
  const {rows,cols} = gs;
  const board = document.getElementById('board');
  board.style.gridTemplateColumns = `repeat(${cols},36px)`;
  board.innerHTML = '';

  for(let i=0;i<rows*cols;i++){
    const el = document.createElement('div');
    el.className = 'cell';
    el.dataset.idx = i;

    // TOUCH events (iPad friendly)
    el.addEventListener('touchstart', e=>{ e.preventDefault(); startPress(i,el); }, {passive:false});
    el.addEventListener('touchend',   e=>{ e.preventDefault(); endPress(i,el); },   {passive:false});
    el.addEventListener('touchmove',  e=>{ e.preventDefault(); cancelPress(); },     {passive:false});

    // Mouse fallback
    el.addEventListener('mousedown', ()=>startPress(i,el));
    el.addEventListener('mouseup',   ()=>endPress(i,el));
    el.addEventListener('mouseleave',()=>cancelPress());
    el.addEventListener('contextmenu',e=>e.preventDefault());

    board.appendChild(el);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LONG PRESS LOGIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startPress(idx, el) {
  cancelPress();
  if (!gs || gs.status !== 'playing') return;
  pressIdx = idx;
  isPressing = true;
  el.classList.add('pressing');
  pressTimer = setTimeout(()=>{ isPressing=false; handleFlag(idx,el); }, LONG_MS);
}

function endPress(idx, el) {
  el.classList.remove('pressing');
  if (!isPressing) { cancelPress(); return; }  // was long press
  clearTimeout(pressTimer);
  isPressing = false;
  pressTimer = null;
  handleReveal(idx);
}

function cancelPress() {
  clearTimeout(pressTimer);
  pressTimer = null;
  isPressing = false;
  if (pressIdx >= 0) {
    const el = document.querySelector(`[data-idx="${pressIdx}"]`);
    if (el) el.classList.remove('pressing');
  }
  pressIdx = -1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function handleReveal(idx) {
  if (!gs || gs.status !== 'playing') return;
  const cs = gs.cells[idx];
  if (cs !== 0) return; // already revealed or flagged

  // Generate board on first reveal
  const isFirstClick = !gs.board;
  if (!gs.board) {
    gs.board = genBoard(gs.rows, gs.cols, gs.mines, idx);
  }

  const val = gs.board[idx];
  const pk = myPlayer===1 ? 'p1' : 'p2';

  if (val === -1) {
    // MINE HIT
    gs.cells[idx] = 99;
    gs[`${pk}Score`]  += PTS_HIT;
    gs[`${pk}Hits`]++;
    gs.status = 'lost';
    toast('ğŸ’¥ BOOM!');
  } else {
    // Safe â€” flood reveal (no points for revealing, only flags score)
    const revealed = floodReveal(idx);
    gs[`${pk}Cells`] += revealed;
    if (checkWin()) {
      gs.status = 'won';
      toast('ğŸ‰ All cleared!');
    }
  }

  gs.version = (gs.version||0)+1;
  await set(ref(db,`mf/${roomCode}`), gs);
  renderBoard(); updateHUD();
  if (gs.status==='won'||gs.status==='lost') setTimeout(()=>showOverlay(gs.status),500);
}

async function handleFlag(idx, el) {
  if (!gs || gs.status !== 'playing') return;
  const cs = gs.cells[idx];
  const myFlag = myPlayer===1 ? -1 : -2;
  const otherFlag = myPlayer===1 ? -2 : -1;
  const pk = myPlayer===1 ? 'p1' : 'p2';

  if (cs === 0) {
    // Place flag
    gs.cells[idx] = myFlag;
    gs[`${pk}Flags`]++;
    if (gs.board) {
      if (gs.board[idx] === -1) {
        gs[`${pk}Score`] += PTS_MINE;   // correct! found a mine
        gs[`${pk}MinesFound`] = (gs[`${pk}MinesFound`]||0) + 1;
        toast('ğŸ’£ Mine found! +100');
      } else {
        gs[`${pk}Score`] += PTS_WRONG;  // wrong flag on safe cell
        toast('âŒ Wrong flag! -50');
      }
    } else {
      toast('ğŸš© Flag placed!');
    }
  } else if (cs === myFlag) {
    // Remove own flag â€” reverse the score
    gs.cells[idx] = 0;
    gs[`${pk}Flags`]--;
    if (gs.board) {
      if (gs.board[idx] === -1) {
        gs[`${pk}Score`] -= PTS_MINE;
        gs[`${pk}MinesFound`] = Math.max(0,(gs[`${pk}MinesFound`]||0) - 1);
      } else {
        gs[`${pk}Score`] -= PTS_WRONG;
      }
    }
    toast('ğŸ³ Flag removed');
  } else if (cs === otherFlag) {
    toast("Can't remove teammate's flag");
    return;
  } else {
    return; // revealed
  }

  gs.version = (gs.version||0)+1;
  await set(ref(db,`mf/${roomCode}`), gs);
  renderBoard(); updateHUD();
}

function floodReveal(start) {
  const {rows,cols} = gs;
  const revVal = myPlayer===1 ? 1 : 2;
  let count = 0;
  const q=[start], vis=new Set([start]);
  while(q.length){
    const idx=q.shift();
    if(gs.cells[idx]<0) continue; // flagged
    if(gs.cells[idx]>0&&gs.cells[idx]<90) continue; // revealed
    gs.cells[idx]=revVal;
    count++;
    if(gs.board[idx]===0){
      const r=Math.floor(idx/cols),c=idx%cols;
      for(let dr=-1;dr<=1;dr++) for(let dc=-1;dc<=1;dc++){
        const nr=r+dr,nc=c+dc,ni=nr*cols+nc;
        if(nr>=0&&nr<rows&&nc>=0&&nc<cols&&!vis.has(ni)&&gs.cells[ni]===0){
          vis.add(ni); q.push(ni);
        }
      }
    }
  }
  return count;
}

function checkWin() {
  const total=gs.rows*gs.cols;
  for(let i=0;i<total;i++){
    if(gs.board&&gs.board[i]!==-1&&gs.cells[i]===0) return false;
  }
  return true;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderBoard() {
  if (!gs) return;
  const {rows,cols} = gs;
  const cells = document.querySelectorAll('#board .cell');
  const gameOver = gs.status==='won'||gs.status==='lost';

  for(let i=0;i<rows*cols;i++){
    const cs=gs.cells[i];
    const el=cells[i];
    if(!el) continue;
    el.className='cell';
    el.textContent='';

    if(cs===99){
      el.classList.add('boom-cell');
      el.textContent='ğŸ’£';
    } else if(cs===1||cs===2){
      el.classList.add(cs===1?'rev-p1':'rev-p2');
      if(gs.board){
        const v=gs.board[i];
        if(v>0){ el.textContent=v; el.classList.add(`n${v}`); }
      }
    } else if(cs===-1){
      el.classList.add('flag-p1'); el.textContent='ğŸš©';
    } else if(cs===-2){
      el.classList.add('flag-p2'); el.textContent='ğŸ”µ';
    } else if(gameOver&&gs.board&&gs.board[i]===-1){
      el.classList.add('rev-p1'); el.textContent='ğŸ’£';
    }
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateHUD() {
  if(!gs) return;
  const {p1Score,p2Score,p1Cells,p2Cells,p1Flags,p2Flags,p1Hits,p2Hits,mines} = gs;

  document.getElementById('p1pts').textContent=p1Score||0;
  document.getElementById('p2pts').textContent=p2Score||0;
  document.getElementById('p1detail').textContent=`ğŸ’£ ${gs.p1MinesFound||0} found Â· ${p1Flags||0} flags${p1Hits?` Â· ${p1Hits}ğŸ’¥`:''}`;
  document.getElementById('p2detail').textContent=`ğŸ’£ ${gs.p2MinesFound||0} found Â· ${p2Flags||0} flags${p2Hits?` Â· ${p2Hits}ğŸ’¥`:''}`;

  // leading highlight
  const s1=document.getElementById('p1score'), s2=document.getElementById('p2score');
  s1.classList.remove('leading-p1','leading-p2');
  s2.classList.remove('leading-p1','leading-p2');
  if((p1Score||0)>(p2Score||0)){ s1.classList.add('leading-p1'); }
  else if((p2Score||0)>(p1Score||0)){ s2.classList.add('leading-p2'); }

  // mines remaining
  const flags=(p1Flags||0)+(p2Flags||0);
  document.getElementById('minesLeft').textContent=Math.max(0,mines-flags);

  // progress
  const total=gs.rows*gs.cols;
  const safeCells=gs.board?Array(total).fill(0).filter((_,i)=>gs.board[i]!==-1).length:total-mines;
  const revealed=gs.cells.filter(c=>c===1||c===2).length;
  const pct=safeCells>0?Math.min(100,Math.round(revealed/safeCells*100)):0;
  document.getElementById('progressBar').style.width=pct+'%';

  // status
  const sb=document.getElementById('statusBar');
  if(gs.status==='playing'){
    sb.className='status-bar go';
    sb.innerHTML=`<span class="live-dot"></span>${pct}% CLEARED â€” ${gs.p1Name}: ${p1Score||0}pts (ğŸ’£${gs.p1MinesFound||0})  Â·  ${gs.p2Name}: ${p2Score||0}pts (ğŸ’£${gs.p2MinesFound||0})`;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startTimer() {
  if(timerItv) clearInterval(timerItv);
  timerItv=setInterval(()=>{
    if(!gs||!gs.startTime) return;
    const s=Math.floor((Date.now()-gs.startTime)/1000);
    document.getElementById('timerEl').textContent=
      `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  },1000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showOverlay(status) {
  const overlay=document.getElementById('overlay');
  overlay.classList.add('show');
  const {p1Name,p2Name,p1Score,p2Score,p1Cells,p2Cells,p1Flags,p2Flags} = gs;
  const s1=p1Score||0, s2=p2Score||0;
  const isWin=status==='won';

  document.getElementById('ovEmoji').textContent=isWin?'ğŸ‰':'ğŸ’¥';
  document.getElementById('ovTitle').textContent=isWin?'CLEARED!':'BOOM!';
  document.getElementById('ovSub').textContent=isWin
    ?'All safe cells revealed â€” amazing teamwork!'
    :'Someone hit a mine â€” try again!';

  const winner = s1>=s2 ? 1 : 2;
  document.getElementById('ovScores').innerHTML=`
    <div class="ov-score ${winner===1?'winner':'loser'}">
      <div class="ov-score-name">ğŸŸ¡ ${p1Name||'P1'}</div>
      <div class="ov-score-pts" style="color:var(--p1)">${s1}</div>
      <div class="ov-score-detail">ğŸ’£ ${gs.p1MinesFound||0} mines found Â· ${p1Flags||0} flags</div>
    </div>
    <div class="ov-score ${winner===2?'winner':'loser'}">
      <div class="ov-score-name">ğŸ”µ ${p2Name||'P2'}</div>
      <div class="ov-score-pts" style="color:var(--p2)">${s2}</div>
      <div class="ov-score-detail">ğŸ’£ ${gs.p2MinesFound||0} mines found Â· ${p2Flags||0} flags</div>
    </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESTART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function restartGame() {
  document.getElementById('overlay').classList.remove('show');
  if(myPlayer!==1){ toast('Only Player 1 can restart'); return; }
  const d=DIFF[gs.diff||'easy'];
  const next={
    ...gs,
    status:'playing', board:null,
    cells:Array(d.rows*d.cols).fill(0),
    p1Score:0,p2Score:0,p1Cells:0,p2Cells:0,
    p1Flags:0,p2Flags:0,p1Hits:0,p2Hits:0,p1MinesFound:0,p2MinesFound:0,
    startTime:Date.now(),
    version:(gs.version||0)+1
  };
  await set(ref(db,`mf/${roomCode}`),next);
  gs=next;
  buildBoardDOM(); renderBoard(); updateHUD();
  toast('New game started!');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEAVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function leaveRoom() {
  cancelPress();
  if(unsub){unsub();unsub=null;}
  if(timerItv){clearInterval(timerItv);timerItv=null;}
  if(roomCode&&myPlayer===1){
    try{await remove(ref(db,`mf/${roomCode}`));}catch(e){}
  }
  document.getElementById('overlay').classList.remove('show');
  gs=null; roomCode=''; myPlayer=0;
  showScreen('screen-lobby');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function setLink() {
  const url=`${location.origin}${location.pathname}?room=${roomCode}`;
  document.getElementById('linkText').textContent=url;
}

function copyLink() {
  const url=`${location.origin}${location.pathname}?room=${roomCode||document.getElementById('displayCode').textContent}`;
  navigator.clipboard.writeText(url).then(()=>toast('Link copied!'));
}

let toastTimer=null;
function toast(msg) {
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2200);
}

/* â”€â”€â”€ Auto-join from URL â”€â”€â”€ */
const p=new URLSearchParams(location.search);
const rc=p.get('room');
if(rc){
  document.getElementById('joinCode').value=rc;
  const tip=document.createElement('p');
  tip.style.cssText='font-size:.62rem;color:var(--p2);text-align:center;margin-top:-8px;letter-spacing:.08em;';
  tip.textContent=`ğŸ”— Joining room ${rc} â€” enter your name & tap JOIN`;
  document.querySelector('#screen-lobby .card:last-child').appendChild(tip);
}
</script>
</body>
</html>
